<title>Shreddit</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.10.2/p5.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">


<body>
    <div class="hint">drag an image into the frame (jpg or png), <br> compose with the mouse and push te spacebar to download.</div>

    <script>
        let s, canvas, img, vid
        let m = {x: 0, y: 0}

        function preload() {
            s = loadShader(`shaders/shader.vert`, `shaders/shreddit.frag`);
            img = loadImage('./swim.jpg')
        }

        function setup() {
            canvas = createCanvas(innerWidth, innerHeight, WEBGL);
            vid = createVideo('./imac.mov')
            vid.hide()
            // noLoop()
            pixelDensity(1)

        }

        function resize() {
            canvas.width = innerWidth/2
            canvas.height = innerHeight/2
        }

        function draw() {
            shader(s)
            s.setUniform("u_tex0", vid)
            s.setUniform("u_resolution", [innerWidth,innerHeight]);

            if (frameCount == 1) {
                s.setUniform('uStepsX', Math.random() * 30 + 1)
                s.setUniform('uStepsY', Math.random() * 30 + 1)
            } else {
                s.setUniform("uStepsX", Math.max(closestOdd(Math.floor(m.x / 25)), 1));
                s.setUniform("uStepsY", Math.max(closestOdd(Math.floor((innerHeight - m.y) / 25)), 1));
            }

            s.setUniform("uTimes", 1.)
            rect(0,0,innerWidth,innerHeight)
        }

        function windowResized() {
            resizeCanvas(innerWidth, innerHeight);
        }

        function mousePressed() {
            vid.loop()
        }

        addEventListener('mousemove', e => {
            m.x = e.clientX
            m.y = e.clientY
            redraw()
        })

        document.body.addEventListener('touchmove', e => {
            const touch = e.changedTouches[0];
            m.x = touch.clientX
            m.y = touch.clientY
            redraw()
        })

        addEventListener('keypress', e => {
            if (e.code == 'Space') {
                var link = document.createElement('a');
                link.download = 'shredded.png';
                link.href = document.querySelector('canvas').toDataURL("image/png")
                link.click();
            }
        })

        addEventListener('dragover', e => {
            e.preventDefault();
        })

        addEventListener('drop', e => {
            e.preventDefault();
            const file = e.dataTransfer.items[0].getAsFile()
            const reader = new FileReader()
            reader.readAsDataURL(file)
            reader.onload = e => {
                console.log(e.target.result)
                img = loadImage(e.target.result)
                redraw()
            }
        })


        // Utils
        function closestOdd(n) {
            if (n % 2 == 0) {
                return n
            } else {
                return n - 1
            }
        }
    </script>


    <style>
        body {
            background: black;
        }

        body, html {
            touch-action: auto;
            margin: 0;
            position: fixed;
            padding: 0;
            width: 100vw;
            height: 100vh;
        }

        canvas {
            margin: 0;
            position: fixed;
            padding: 0;
        }

        .hint {
            position: fixed;
            top: 20px;
            left: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: white;
            font-size: 12px;
            z-index: 1;
        }

        @media(hover: none) {
            .hint {
                display: none;
            }
        }

        @keyframes hint {
            0% {
                opacity: 0;
            }

            25% {
                opacity: 1;
            }

            50% {
                opacity: 1;
            }

            75% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }
    </style>

</body>
